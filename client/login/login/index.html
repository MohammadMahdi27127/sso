<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>قالب فرم چند مرحله ای همراه با نوار پیشرفت</title>
    <link rel="stylesheet" href="css/reset.min.css">
    <link type="text/css" href="css/style.css" rel="stylesheet" />
</head>
<body>

    <form id="msform">

        <ul id="progressbar">
            <li class="active">شماره موبایل</li>
            <li>وارد کردن کد</li>
            <li>ورود</li>
        </ul>

        <fieldset>
            <h2 class="fs-title">ورود به حساب کاربری</h2>
            <p id="username"></p>
            <input type="tel" name="phone" id="phone" placeholder="شماره موبایل..." pattern="[0-9]{11}" required />
            <input type="button" name="next" class="next action-button" value="ارسال پیامک" onclick="login()" id="fieldCodeOpen" />
        </fieldset>

        <fieldset>
            <h2 class="fs-title">کد ارسال شد...</h2>
            <p id="username2"></p>
            <input type="text" name="code" id="code" placeholder="کد را وارد کنید..." required/>
            <input type="button" name="previous" id="back" class="previous action-button" value="ویرایش شماره" onclick="goBack()" />
            <input type="button" name="next" id="next" class="next submit action-button" value="ورود" onclick="verifyCode()" />
        </fieldset>

    </form>

    <script src="jquery-3.1.1.min.js"></script>
    <script src="jquery.easing.min.js" type="text/javascript"></script>
    <script>
        var current_fs, next_fs, previous_fs;
        var left, opacity, scale;
        var animating;

        function login() {
            const phoneInput = document.getElementById('phone').value;
            const phonePattern = /^[0-9]{11}$/;

            if (phonePattern.test(phoneInput)) {
                // Call your API to validate the phone number
                $.ajax({
                    url: 'http://127.0.0.1:8000/create_mobile/',
                    type: 'POST',
                    data: { phone: phoneInput },  // ارسال شماره موبایل
                    success: function(response) {
                        // Assuming the API returns a success response
                        if (response) {  // بررسی پاسخ
                            // ادامه کد برای پیشرفت فرم
                            $(".next").click(function () {
                                if (animating) return false;
                                animating = true;

                                document.getElementById('username2').innerText = 'نام کاربری: ' + phoneInput;
                                current_fs = $(this).parent();
                                next_fs = $(this).parent().next();

                                $("#progressbar li").eq($("fieldset").index(next_fs)).addClass("active");

                                next_fs.show();
                                current_fs.animate({ opacity: 0 }, {
                                    step: function (now, mx) {
                                        scale = 1 - (1 - now) * 0.2;
                                        left = (now * 50) + "%";
                                        opacity = 1 - now;
                                        current_fs.css({ 'transform': 'scale(' + scale + ')' });
                                        next_fs.css({ 'left': left, 'opacity': opacity });
                                    },
                                    duration: 800,
                                    complete: function () {
                                        current_fs.hide();
                                        animating = false;
                                    },
                                    easing: 'easeInOutBack'
                                });
                            });
                        } else {
                            alert('شماره تلفن معتبر نیست.');
                        }
                    },
                    error: function(xhr) {
                        alert('خطا در برقراری ارتباط با سرور: ' + xhr.responseText);
                    }
                });
            } else {
                alert('لطفاً یک شماره تلفن معتبر وارد کنید.');
            }
        }

        function goBack() {
            // Clear the code input
            document.getElementById('code').value = '';
            // Go back to the previous fieldset
            $(".previous").click();
        }

        function verifyCode() {
            const codeInput = document.getElementById('code').value;
            // Call your API to verify the code
            $.ajax({
                url: 'http://127.0.0.1:8000/verify_code/',  // فرض بر این است که این URL برای تایید کد است
                type: 'POST',
                data: { code: codeInput },
                success: function(response) {
                    if (response.success) {
                        alert('ورود موفقیت آمیز بود!');
                        // Redirect to the next page
                        window.location.href = 'nextPage.html'; // Replace with your next page URL
                    } else {
                        alert('کد اشتباه است. لطفاً دوباره تلاش کنید.');
                        // Lock the user out for 3 minutes
                        setTimeout(function() {
                            alert('شما نمی‌توانید دوباره تلاش کنید تا 3 دقیقه دیگر.');
                        }, 180000); // 3 minutes
                    }
                },
                error: function() {
                    alert('خطا در برقراری ارتباط با سرور.');
                }
            });
        }
    </script>
</body>
</html>