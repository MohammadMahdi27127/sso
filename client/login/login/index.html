<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>قالب فرم چند مرحله ای همراه با نوار پیشرفت</title>
    <link rel="stylesheet" href="css/reset.min.css">
    <link type="text/css" href="css/style.css" rel="stylesheet" />
</head>
<body>

    <form id="msform">

        <ul id="progressbar">
            <li class="active">شماره موبایل</li>
            <li>وارد کردن کد</li>
            <li>ورود</li>
        </ul>

        <fieldset>
            <h2 class="fs-title">ورود به حساب کاربری</h2>
            <p id="username"></p>
            <input type="tel" name="phone" id="phone" placeholder="شماره موبایل..." pattern="[0-9]{11}" required />
            <input type="button" name="next" class="next action-button" value="ارسال پیامک" onclick="login()" id="fieldCodeOpen" />
        </fieldset>

        <fieldset>
            <h2 class="fs-title">کد ارسال شد...</h2>
            <p id="username2"></p>
            <input type="text" name="code" id="code" placeholder="کد را وارد کنید..." required/>
            <input type="button" name="previous" id="back" class="previous action-button" value="ویرایش شماره" onclick="goBack()" />
            <input type="button" name="next" id="next" class="next submit action-button" value="ورود" onclick="verifyCode()" />
        </fieldset>

    </form>


    <script src="jquery-3.1.1.min.js"></script>
    <script src="jquery.easing.min.js" type="text/javascript"></script>
    <script>
        var current_fs, next_fs, previous_fs;
        var left, opacity, scale;
        var animating;

        function login() {
            const phoneInput = document.getElementById('phone').value;
            const phonePattern = /^[0-9]{11}$/;

            if (phonePattern.test(phoneInput)) {
                // فراخوانی API برای اعتبارسنجی شماره تلفن
                $.ajax({
                    url: 'YOUR_API_ENDPOINT', // اینجا URL API خود را قرار دهید
                    type: 'POST',
                    data: { phone: phoneInput },
                    success: function(response) {
                        // فرض بر این است که API پاسخ موفقیت‌آمیز می‌دهد
                        if (response.success) {
                            document.getElementById('username2').innerText = 'نام کاربری: ' + phoneInput;
                            save(phoneInput); // فراخوانی تابع save با شماره تلفن

                            $(".next").click(function () {
                                if (animating) return false;
                                animating = true;

                                $("#progressbar li").eq($("fieldset").index(next_fs)).addClass("active");

                                next_fs.show();
                                current_fs.animate({ opacity: 0 }, {
                                    step: function (now, mx) {
                                        scale = 1 - (1 - now) * 0.2;
                                        left = (now * 50) + "%";
                                        opacity = 1 - now;
                                        current_fs.css({ 'transform': 'scale(' + scale + ')' });
                                        next_fs.css({ 'left': left, 'opacity': opacity });
                                    },
                                    duration: 800,
                                    complete: function () {
                                        current_fs.hide();
                                        animating = false;
                                    },
                                    easing: 'easeInOutBack'
                                });
                            });
                        } else {
                            alert('شماره تلفن معتبر نیست.');
                        }
                    },
                    error: function() {
                        alert('خطا در برقراری ارتباط با سرور.');
                    }
                });
            } else {
                alert('لطفاً یک شماره تلفن معتبر وارد کنید.');
            }
        }

        function goBack() {
            // پاک کردن ورودی کد
            document.getElementById('code').value = '';
            // بازگشت به فیلدست قبلی
            $(".previous").click();
        }

        function verifyCode() {
            const codeInput = document.getElementById('code').value;
            // فراخوانی API برای تأیید کد
            $.ajax({
                url: 'YOUR_API_VERIFY_ENDPOINT', // اینجا URL API تأیید خود را قرار دهید
                type: 'POST',
                data: { code: codeInput },
                success: function(response) {
                    if (response.success) {
                        alert('ورود موفقیت آمیز بود!');
                        // انتقال به صفحه بعد
                        window.location.href = 'nextPage.html'; // اینجا URL صفحه بعد خود را قرار دهید
                    } else {
                        alert('کد اشتباه است. لطفاً دوباره تلاش کنید.');
                        // قفل کردن کاربر برای 3 دقیقه
                        setTimeout(function() {
                            alert('شما نمی‌توانید دوباره تلاش کنید تا 3 دقیقه دیگر.');
                        }, 180000); // 3 دقیقه
                    }
                },
                error: function() {
                    alert('خطا در برقراری ارتباط با سرور.');
                }
            });
        }

        async function save(phone) {
            const username = getUsernameFromURL('username'); // فرض بر این است که 'username' نام پارامتر است
            const connectionConfig = {
                // پیکربندی اتصال MySQL شما در اینجا
                host: 'localhost',
                user: 'yourUsername',
                password: 'yourPassword',
                database: 'yourDatabase'
            };

            const connection = await mysql.createConnection(connectionConfig);
            try {
                const [results] = await connection.query('UPDATE sso_sms SET source = ? WHERE mobile = ?', [username, phone]);
                return results;
            } catch (err) {
                console.error('خطا در اجرای کوئری:', err.stack);
                throw err; // پرتاب خطا برای مدیریت در تابع فراخوانی
            } finally {
                await connection.end(); // بستن اتصال
            }
        }

        function getUsernameFromURL(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param); // فرض بر این است که نام کاربری در URL به صورت ?username=yourUsername قرار دارد
        }
    </script>
</body>
</html>